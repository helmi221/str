<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strategic Management Toolkit</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <style>
      :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --bg-dark: #2c3e50;
        --bg-light: #f4f7f6;
        --card-bg: #ffffff;
        --text-light: #ecf0f1;
        --text-dark: #34495e;
        --border-color: #dee2e6;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-light);
        color: var(--text-dark);
        display: flex;
      }

      .app-container {
        display: flex;
        width: 100vw;
        height: 100vh;
      }

      .sidebar {
        width: 240px;
        background-color: var(--bg-dark);
        color: var(--text-light);
        padding: 20px 0;
        height: 100vh;
        overflow-y: auto;
        flex-shrink: 0;
        /* --- v12.0 Change: Added Flex --- */
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        text-align: center;
        padding: 0 20px 20px 20px;
        font-size: 1.2rem;
        border-bottom: 1px solid #4a627a;
      }

      .sidebar-footer {
        /* --- v12.0 Change: Moved to bottom --- */
        padding: 10px 20px;
        text-align: center;
        font-size: 0.85rem;
        color: #aaa;
        border-top: 1px solid #4a627a; /* Changed from border-bottom */
        margin-top: 20px; /* Pushes it down */
      }

      .sidebar nav {
        /* --- v12.0 Change: Added Flex Grow --- */
        flex-grow: 1;
      }

      .sidebar nav button {
        display: block;
        width: 100%;
        padding: 18px 25px;
        background: none;
        border: none;
        color: var(--text-light);
        text-align: left;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }

      .sidebar nav button:hover {
        background-color: #34495e;
      }

      .sidebar nav button.active {
        background-color: #4a627a;
        border-left: 4px solid var(--primary-color);
        font-weight: 600;
      }

      .main-content {
        flex-grow: 1;
        height: 100vh;
        overflow-y: auto;
        padding: 25px;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .page-header h1 {
        font-size: 2rem;
        color: var(--text-dark);
      }

      .info-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .info-btn:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-hover);
      }

      .tool-page {
        display: none;
      }

      .tool-page.active {
        display: block;
      }

      .card {
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 25px;
        margin-bottom: 25px;
        overflow-x: auto;
      }

      .card h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }

      .form-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
      }

      .form-group label {
        font-weight: 600;
        flex-basis: 150px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      input[type="text"],
      input[type="number"],
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 0.95rem;
        flex-grow: 1;
      }

      textarea {
        width: 100%;
        min-height: 80px;
      }

      button {
        padding: 10px 18px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #0056b3;
      }

      button.danger {
        background-color: #dc3545;
      }
      button.danger:hover {
        background-color: #c82333;
      }

      button.secondary {
        background-color: var(--secondary-color);
      }
      button.secondary:hover {
        background-color: #5a6268;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        min-width: 600px;
      }

      th,
      td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: left;
        vertical-align: middle;
      }

      th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      td input[type="number"] {
        width: 80px;
        padding: 8px;
      }

      .totals {
        margin-top: 25px;
        padding: 20px;
        background: #fdfdfd;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .totals p {
        margin-bottom: 10px;
      }

      .totals .analysis-result {
        font-weight: normal;
        font-size: 1rem;
        color: var(--text-dark);
        margin-top: 10px;
        border-top: 1px dashed var(--border-color);
        padding-top: 10px;
      }

      .swot-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      #ai-report-output {
        white-space: pre-wrap;
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 20px;
        min-height: 200px;
        line-height: 1.6;
      }

      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        padding-top: 60px;
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 30px;
        border: 1px solid #888;
        width: 80%;
        max-width: 700px;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        color: var(--primary-color);
      }

      .close-btn {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-btn:hover,
      .close-btn:focus {
        color: black;
        text-decoration: none;
      }

      .arabic-note {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(-50px);
        }
        to {
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          flex-direction: row;
          overflow-x: auto;
        }
        .main-content {
          padding: 10px;
        }
        .app-container {
          flex-direction: column;
          height: auto;
        }
        .sidebar nav button {
          padding: 15px;
          font-size: 0.9rem;
          border-left: none;
          border-bottom: 4px solid transparent;
        }
        .sidebar nav {
          display: flex;
          flex-direction: row;
          width: 100%;
        }
        .swot-grid,
        .form-grid {
          grid-template-columns: 1fr;
        }
        .form-group {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>Strategy Toolkit</h3>
        </div>

        <nav id="main-nav"></nav>

        <div class="sidebar-footer">
          <p>Developed by Helmi Tbaileh</p>
        </div>
      </div>

      <main class="main-content">
        <header class="page-header">
          <h1 id="page-title">Welcome</h1>
          <button class="info-btn" id="info-btn">i</button>
        </header>

        <section id="page-welcome" class="tool-page active">
          <div class="card">
            <h2>Project Setup & Company Info</h2>
            <p>
              Welcome! Start by entering your company's information. All data is
              saved automatically as you type.
            </p>
            <div class="form-grid" style="margin-top: 20px">
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-name">Company Name</label>
                <input
                  type="text"
                  id="company-name"
                  placeholder="e.g., Apple Inc."
                  oninput="app.companyInfo.save()"
                />
              </div>
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-industry">Industry</label>
                <input
                  type="text"
                  id="company-industry"
                  placeholder="e.g., Technology"
                  oninput="app.companyInfo.save()"
                />
              </div>
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-country">Country / Region</label>
                <input
                  type="text"
                  id="company-country"
                  placeholder="e.g., USA"
                  oninput="app.companyInfo.save()"
                />
              </div>
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-notes">Other Notes</label>
                <input
                  type="text"
                  id="company-notes"
                  placeholder="e.g., Publicly traded, founded 1976"
                  oninput="app.companyInfo.save()"
                />
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Project Management</h2>
            <div class="form-group">
              <button id="export-data" onclick="app.exportData()">
                Export Project Data (JSON)
              </button>
              <button
                id="import-data-btn"
                class="secondary"
                onclick="app.importData()"
              >
                Import Project Data (JSON)
              </button>
              <input
                type="file"
                id="import-file"
                accept=".json"
                style="display: none"
                onchange="app.loadFromFile(event)"
              />
              <button
                id="clear-data"
                class="danger"
                onclick="app.clearAllData()"
              >
                Clear All Project Data
              </button>
            </div>
          </div>
        </section>

        <section id="page-ife" class="tool-page">
          <div class="card">
            <h2>Add New Internal Factor</h2>
            <div class="form-group">
              <select id="ife-type">
                <option value="strength">Strength (Rating 3 or 4)</option>
                <option value="weakness">Weakness (Rating 1 or 2)</option>
              </select>
              <input
                type="text"
                id="ife-text"
                placeholder="Factor Description (e.g., 'Strong brand reputation')"
              />
              <input
                type="number"
                id="ife-weight"
                placeholder="Weight (0.01 - 1.0)"
                step="0.01"
              />
              <input
                type="number"
                id="ife-rating"
                placeholder="Rating (1-4)"
                min="1"
                max="4"
              />
              <button onclick="app.ife.add()">Add Factor</button>
            </div>
          </div>
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2>Internal Factor Evaluation (IFE) Matrix</h2>
              <button class="secondary" onclick="app.ife.export()">
                Export to Excel (CSV)
              </button>
            </div>
            <table id="ife-table">
              <thead>
                <tr>
                  <th>Factor Description</th>
                  <th>Type</th>
                  <th>Weight</th>
                  <th>Rating</th>
                  <th>Weighted Score</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="totals" id="ife-totals"></div>
          </div>
        </section>

        <section id="page-efe" class="tool-page">
          <div class="card">
            <h2>Add New External Factor</h2>
            <div class="form-group">
              <select id="efe-type">
                <option value="opportunity">Opportunity (Rating 3 or 4)</option>
                <option value="threat">Threat (Rating 1 or 2)</option>
              </select>
              <input
                type="text"
                id="efe-text"
                placeholder="Factor Description (e.g., 'Growing market demand')"
              />
              <input
                type="number"
                id="efe-weight"
                placeholder="Weight (0.01 - 1.0)"
                step="0.01"
              />
              <input
                type="number"
                id="efe-rating"
                placeholder="Rating (1-4)"
                min="1"
                max="4"
              />
              <button onclick="app.efe.add()">Add Factor</button>
            </div>
          </div>
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2>External Factor Evaluation (EFE) Matrix</h2>
              <button class="secondary" onclick="app.efe.export()">
                Export to Excel (CSV)
              </button>
            </div>
            <table id="efe-table">
              <thead>
                <tr>
                  <th>Factor Description</th>
                  <th>Type</th>
                  <th>Weight</th>
                  <th>Rating</th>
                  <th>Weighted Score</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="totals" id="efe-totals"></div>
          </div>
        </section>

        <section id="page-cpm" class="tool-page">
          <div class="card">
            <h2>Manage Competitors</h2>
            <div class="form-group">
              <input
                type="text"
                id="cpm-competitor-name"
                placeholder="New Competitor Name"
              />
              <button onclick="app.cpm.addCompetitor()">Add Competitor</button>
            </div>
            <p>
              Your firm (Column 1) and competitors are:
              <strong id="cpm-competitor-list"></strong>
            </p>
          </div>
          <div class="card">
            <h2>Add New Critical Success Factor</h2>
            <div class="form-group">
              <input
                type="text"
                id="cpm-factor-text"
                placeholder="Factor (e.g., 'Market Share')"
              />
              <input
                type="number"
                id="cpm-factor-weight"
                placeholder="Weight (0.01 - 1.0)"
                step="0.01"
              />
              <button onclick="app.cpm.addFactor()">Add Factor</button>
            </div>
          </div>
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2>Competitive Profile Matrix (CPM)</h2>
              <button class="secondary" onclick="app.cpm.export()">
                Export to Excel (CSV)
              </button>
            </div>
            <table id="cpm-table">
              <thead></thead>
              <tbody></tbody>
              <tfoot></tfoot>
            </table>
          </div>
        </section>

        <section id="page-bcg" class="tool-page">
          <div class="card">
            <h2>Add New Division</h2>
            <div class="form-group">
              <input
                type="text"
                id="bcg-division"
                placeholder="Division Name"
              />
              <input
                type="number"
                id="bcg-firm-revenue"
                placeholder="Your Firm's Revenues"
              />
              <input
                type="number"
                id="bcg-rival-revenue"
                placeholder="Top Rival's Revenues"
              />
              <input
                type="number"
                id="bcg-growth"
                placeholder="Industry Growth Rate (%)"
                step="0.1"
              />
              <button onclick="app.bcg.add()">Add Division</button>
              <button class="danger" onclick="app.bcg.clear()">
                Clear All
              </button>
            </div>
          </div>
          <div class="card">
            <h2>Boston Consulting Group (BCG) Matrix</h2>
            <div
              style="width: 100%; max-width: 700px; margin: auto; padding: 10px"
            >
              <canvas id="bcgChart"></canvas>
            </div>
          </div>
        </section>

        <section id="page-ai-report" class="tool-page">
          <div class="card">
            <h2>AI-Powered Strategic Report Generator</h2>
            <p>
              This tool will analyze all the data you have entered (IFE, EFE,
              CPM, BCG, etc.) and generate a comprehensive strategic analysis
              report.
            </p>
            <div class="form-group">
              <label for="ai-language">Select Report Language:</label>
              <select id="ai-language">
                <option value="English">English</option>
                <option value="Arabic">Arabic (العربية)</option>
              </select>
              <button id="ai-generate-btn" onclick="app.aiReport.generate()">
                Generate AI Report
              </button>
            </div>
          </div>
          <div class="card">
            <h2>Generated Report</h2>
            <div class="loader" id="ai-loader"></div>
            <div id="ai-report-output">
              Your report will appear here. Click "Generate" to begin...
            </div>
          </div>
        </section>
      </main>
    </div>

    <div id="info-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Info</h2>
          <span class="close-btn" onclick="app.closeModal()">&times;</span>
        </div>
        <div id="modal-body">
          <p>Welcome!</p>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const app = {
          data: {},
          charts: {
            bcg: null,
          },

          tools: [
            { id: "welcome", name: "Welcome" },
            { id: "ife", name: "IFE Matrix" },
            { id: "efe", name: "EFE Matrix" },
            { id: "cpm", name: "CPM Matrix" },
            { id: "bcg", name: "BCG Matrix" },
            { id: "ai-report", name: "AI Report Generator" },
          ],

          infoContent: {
            welcome: {
              title: "Welcome!",
              body: `<p>This tool is designed to guide you through the strategic analysis process. All data is saved in your browser's local storage.</p>
                       <p><strong>New Features:</strong> Enter your company's basic info below. You can also export your entire project as a JSON file for backup, or import a previous project.</p>
                       <div class="arabic-note" dir="rtl" lang="ar">
                       <h4>مرحباً بك!</h4>
                       <p>هذه الأداة مصممة لمساعدتك في إجراء جميع التحليلات الرئيسية لدراسة حالة في الإدارة الاستراتيجية.</p>
                       <p><strong>ميزات جديدة:</strong><br>
                       1. أدخل معلومات شركتك الأساسية في النموذج أدناه.<br>
                       2. يمكنك الآن تصدير (Export) مشروعك بالكامل كملف JSON، أو استيراد (Import) مشروع سابق، أو مسح كل البيانات (Clear All).</p>
                       </div>`,
            },
            ife: {
              title: "IFE Matrix (Internal Factor Evaluation)",
              body: `<p>The IFE matrix summarizes and evaluates the major strengths and weaknesses in the functional areas of a business.</p>
                       <strong>How to use:</strong>
                       <ol>
                           <li>List key internal factors (10-20 total).</li>
                           <li>Assign a <strong>Weight</strong> (0.0 to 1.0) to each factor, based on its importance to the *industry*. The sum of all weights must equal 1.0.</li>
                           <li>Assign a <strong>Rating</strong> (1 to 4) to each factor, based on how well the *company* is doing on this factor. (4 = Major Strength, 3 = Minor Strength, 2 = Minor Weakness, 1 = Major Weakness)</li>
                           <li>The total score (1.0 to 4.0) indicates the firm's internal position. A score above 2.5 is strong.</li>
                       </ol>
                       <div class="arabic-note" dir="rtl" lang="ar">
                       <h4>مصفوفة العوامل الداخلية (IFE)</h4>
                       <p>هذه المصفوفة تلخص وتقيّم نقاط القوة والضعف الرئيسية لشركتك.</p>
                       <strong>ماذا أفعل؟</strong>
                       <ol>
                           <li>أضف عوامل داخلية (10-20 عامل).</li>
                           <li>أعطِ كل عامل <strong>"وزن" (Weight)</strong> من 0.0 إلى 1.0 حسب أهميته *للصناعة*. (يجب أن يكون مجموع الأوزان = 1.0).</li>
                           <li>أعطِ كل عامل <strong>"تقييم" (Rating)</strong> من 1 إلى 4 حسب أداء *شركتك* فيه: (4 = قوة رئيسية, 3 = قوة ثانوية, 2 = ضعف ثانوي, 1 = ضعف رئيسي).</li>
                           <li>الأداة ستحسب النتيجة. النتيجة النهائية فوق 2.5 تعني أن الوضع الداخلي قوي.</li>
                           <li><strong>جديد:</strong> يمكنك الآن تصدير هذا الجدول إلى ملف Excel (CSV).</li>
                       </ol>
                       </div>`,
            },
            efe: {
              title: "EFE Matrix (External Factor Evaluation)",
              body: `<p>The EFE matrix summarizes and evaluates the major opportunities and threats in the external environment.</p>
                       <strong>How to use:</strong>
                       <ol>
                           <li>List key external factors (10-20 total).</li>
                           <li>Assign a <strong>Weight</strong> (0.0 to 1.0) to each, based on its importance to the *industry*. The sum must equal 1.0.</li>
                           <li>Assign a <strong>Rating</strong> (1 to 4) to each, based on how well the *company* is *responding* to this factor. (4 = Superior Response, 3 = Above Average, 2 = Average, 1 = Poor)</li>
                           <li>The total score (1.0 to 4.0) indicates the firm's response to its external environment. A score above 2.5 is good.</li>
                       </ol>
                       <div class="arabic-note" dir="rtl" lang="ar">
                       <h4>مصفوفة العوامل الخارجية (EFE)</h4>
                       <p>هذه المصفوفة تلخص وتقيّم الفرص والتهديدات الخارجية التي تواجه شركتك.</p>
                       <strong>ماذا أفعل؟</strong>
                       <ol>
                           <li>أضف عوامل خارجية (10-20 عامل).</li>
                           <li>أعطِ كل عامل <strong>"وزن" (Weight)</strong> من 0.0 إلى 1.0 حسب أهميته *للصناعة*. (يجب أن يكون مجموع الأوزان = 1.0).</li>
                           <li>أعطِ كل عامل <strong>"تقييم" (Rating)</strong> من 1 إلى 4 حسب جودة *استجابة شركتك* لهذا العامل: (4 = استجابة ممتازة, 3 = فوق المتوسط, 2 = متوسطة, 1 = ضعيفة).</li>
                           <li>النتيجة النهائية فوق 2.5 تعني أن الشركة تستجيب جيداً للبيئة الخارجية.</li>
                       </ol>
                       </div>`,
            },
            cpm: {
              title: "CPM (Competitive Profile Matrix)",
              body: `<p>The CPM identifies a firm's major competitors and compares them on key "Critical Success Factors" (CSFs).</p>
                       <strong>How to use:</strong>
                       <ol>
                           <li>Add your firm and your key competitors using the "Manage Competitors" box.</li>
                           <li>List the Critical Success Factors for the industry (e.g., 'Price', 'Quality', 'Market Share').</li>
                           <li>Assign a <strong>Weight</strong> (0.0 to 1.0) to each CSF. The sum must be 1.0.</li>
                           <li>Assign a <strong>Rating</strong> (1 to 4) for *each company* on *each factor*. (Same as IFE: 4=Major Strength... 1=Major Weakness)</li>
                           <li>The tool calculates the total score for each firm. The highest score wins.</li>
                       </ol>
                       <div class="arabic-note" dir="rtl" lang="ar">
                       <h4>مصفوفة الوضع التنافسي (CPM)</h4>
                       <p>تقارن هذه المصفوفة شركتك بأهم منافسيك بناءً على عوامل النجاح الرئيسية في الصناعة.</p>
                       <strong>ماذا أفعل؟</strong>
                       <ol>
                           <li>أضف شركتك (تلقائياً هي أول عمود) ثم أضف المنافسين من "Manage Competitors".</li>
                           <li>أضف "عوامل النجاح الرئيسية" (CSFs) في صناعتك (مثل: السعر، الجودة، الإعلانات).</li>
                           <li>أعطِ كل عامل <strong>"وزن" (Weight)</strong> من 0.0 إلى 1.0. (المجموع يجب أن = 1.0).</li>
                           <li>أعطِ <strong>"تقييم" (Rating)</strong> من 1 إلى 4 (مثل IFE) *لكل شركة* على *كل عامل*.</li>
                           <li>الأداة ستحسب النتيجة الإجمالية. الشركة صاحبة أعلى مجموع هي الرائدة في المنافسة.</li>
                       </ol>
                       </div>`,
            },
            bcg: {
              title: "BCG Matrix (Boston Consulting Group)",
              body: `<p>The BCG Matrix plots a firm's divisions on a 2x2 grid to help allocate resources.</p>
                       <strong>How to use:</strong>
                       <ol>
                           <li>For each division (or product line):</li>
                           <li>Enter <strong>Your Firm's Revenues</strong> for that division. This controls the bubble size.</li>
                           <li>Enter the <strong>Top Rival's Revenues</strong> for that division.</li>
                           <li>The tool will automatically calculate the <strong>Relative Market Share (RMSP)</strong> for the X-Axis. (RMSP = Your Revenues / Rival's Revenues)</li>
                           <li>Enter the <strong>Industry Growth Rate (IGR)</strong>: (-20% to +20%). (Y-Axis)</li>
                           <li>The chart will plot the division into one of four quadrants: Stars, Question Marks, Cash Cows, or Dogs.</li>
                       </ol>
                       <div class="arabic-note" dir="rtl" lang="ar">
                       <h4>مصفوفة بوسطن (BCG)</h4>
                       <p>هذه المصفوفة تضع أقسام شركتك (أو منتجاتك) على رسم بياني لتساعدك على تحديد أين تستثمر مواردك.</p>
                       <strong>ماذا أفعل؟</strong>
                       <ol>
                           <li>لكل قسم أو منتج، أدخل:</li>
                           <li><strong>إيرادات شركتك (Your Firm's Revenues):</strong> إيرادات هذا القسم (يحدد حجم الدائرة).</li>
                           <li><strong>إيرادات المنافس الأول (Top Rival's Revenues):</strong> إيرادات القسم المنافس الأكبر.</li>
                           <li>ستقوم الأداة بحساب <strong>الحصة السوقية النسبية (RMSP)</strong> تلقائياً (المحور X).</li>
                           <li><strong>معدل نمو الصناعة (Industry Growth Rate):</strong> ما مدى سرعة نمو هذا السوق؟ (استخدم رقم من -20 إلى 20). هذا هو المحور Y.</li>
                           <li>الأداة سترسم الدائرة في المربع الصحيح: (نجوم، استفهام، أبقار حلوب، كلاب).</li>
                       </ol>
                       </div>`,
            },
            "ai-report": {
              title: "AI Report Generator",
              body: `<p>This tool uses the Google Gemini AI model to analyze your entire project.</p>
                       <strong>How to use:</strong>
                       <ol>
                           <li>First, make sure you have filled in data in the other matrices (IFE, EFE, CPM, BCG). The more data, the better the report.</li>
                           <li>Select your desired language for the report.</li>
                           <li>Click "Generate AI Report". The tool will gather all your data and send it to the AI for analysis.</li>
                           <li>Please wait, as this can take 10-30 seconds.</li>
                           <li>The AI will return a comprehensive report, including an executive summary, analysis of each matrix, and strategic recommendations.</li>
                       </ol>
                       <div class="arabic-note" dir="rtl" lang="ar">
                       <h4>مُنشئ التقارير بالذكاء الاصطناعي (AI)</h4>
                       <p>هذه الأداة تستخدم نموذج Gemini من جوجل لتحليل مشروعك بالكامل.</p>
                       <strong>ماذا أفعل؟</strong>
                       <ol>
                           <li>تأكد أولاً من تعبئة البيانات في الأدوات الأخرى (IFE, EFE, CPM, BCG). كلما زادت البيانات، كان التقرير أفضل.</li>
                           <li>اختر اللغة التي تريد التقرير بها (English أو Arabic).</li>
                           <li>اضغط "Generate AI Report". ستقوم الأداة بجمع كل بياناتك وإرسالها للذكاء الاصطناعي لتحليلها.</li>
                           <li>يرجى الانتظار، قد يستغرق الأمر من 10 إلى 30 ثانية.</li>
                           <li>سيقوم الذكاء الاصطناعي بإرجاع تقرير مفصل يتضمن ملخصاً تنفيذياً، وتحليلاً لكل مصفوفة، وتوصيات استراتيجية بناءً على مُدخلاتك.</li>
                       </ol>
                       </div>`,
            },
          },

          init() {
            const nav = document.getElementById("main-nav");
            app.tools.forEach((tool) => {
              nav.innerHTML += `<button id="btn-${tool.id}" onclick="app.showPage('${tool.id}')">
                    ${tool.name}
                </button>`;
            });

            document.getElementById("info-btn").onclick = () => {
              const activePageId = document
                .querySelector(".tool-page.active")
                .id.replace("page-", "");
              app.showModal(activePageId);
            };

            app.loadData();
            app.showPage("welcome");
            app.renderAll();
          },

          showPage(pageId) {
            document
              .querySelectorAll(".tool-page")
              .forEach((p) => p.classList.remove("active"));
            document.getElementById(`page-${pageId}`).classList.add("active");

            document
              .querySelectorAll("#main-nav button")
              .forEach((b) => b.classList.remove("active"));
            document.getElementById(`btn-${pageId}`).classList.add("active");

            const tool = app.tools.find((t) => t.id === pageId);
            document.getElementById("page-title").textContent = tool.name;

            if (pageId === "bcg") app.bcg.render();
          },

          saveData() {
            localStorage.setItem(
              "strategyToolkitData",
              JSON.stringify(app.data)
            );
          },

          loadData() {
            const defaultData = {
              companyInfo: {
                name: "",
                industry: "",
                country: "Palestine",
                notes: "",
              },
              ife: { items: [] },
              efe: { items: [] },
              cpm: { competitors: ["My Firm"], factors: [] },
              bcg: { items: [] },
            };
            app.data =
              JSON.parse(localStorage.getItem("strategyToolkitData")) ||
              defaultData;

            for (const key in defaultData) {
              if (!app.data[key]) {
                app.data[key] = defaultData[key];
              }
            }
          },

          renderAll() {
            app.companyInfo.render();
            app.ife.render();
            app.efe.render();
            app.cpm.render();
            app.bcg.render();
          },

          exportData() {
            const dataStr = JSON.stringify(app.data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "strategy_project.json";
            a.click();
            URL.revokeObjectURL(url);
          },

          importData() {
            document.getElementById("import-file").click();
          },

          loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const importedData = JSON.parse(e.target.result);
                if (
                  confirm(
                    "Are you sure you want to import this data? This will overwrite your current project."
                  )
                ) {
                  app.data = importedData;
                  app.saveData();
                  app.renderAll();
                  alert("Project imported successfully!");
                }
              } catch (error) {
                alert(
                  "Error: Could not import file. Make sure it is a valid JSON file exported from this tool."
                );
              }
            };
            reader.readAsText(file);
            event.target.value = null;
          },

          clearAllData() {
            if (
              confirm(
                "ARE YOU SURE?\nThis will delete all your data (IFE, EFE, CPM, etc.) from this browser."
              )
            ) {
              if (
                confirm(
                  "FINAL WARNING:\nAll data will be permanently lost. Are you sure you want to proceed?"
                )
              ) {
                localStorage.removeItem("strategyToolkitData");
                app.loadData();
                app.renderAll();
                alert("All data has been cleared.");
              }
            }
          },

          exportToCSV(filename, rows) {
            const processRow = (row) => {
              let finalVal = "";
              for (let j = 0; j < row.length; j++) {
                let innerValue =
                  row[j] === null || row[j] === undefined
                    ? ""
                    : row[j].toString();
                if (row[j] instanceof Date) {
                  innerValue = row[j].toLocaleString();
                }
                let result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0)
                  result = '"' + result + '"';
                if (j > 0) finalVal += ",";
                finalVal += result;
              }
              return finalVal + "\n";
            };

            let csvFile = "";
            for (let i = 0; i < rows.length; i++) {
              csvFile += processRow(rows[i]);
            }

            const blob = new Blob([csvFile], {
              type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
          },

          showModal(toolId) {
            const info = app.infoContent[toolId];
            if (info) {
              document.getElementById("modal-title").innerHTML = info.title;
              document.getElementById("modal-body").innerHTML = info.body;
              document.getElementById("info-modal").style.display = "block";
            }
          },

          closeModal() {
            document.getElementById("info-modal").style.display = "none";
          },

          companyInfo: {
            save() {
              app.data.companyInfo = {
                name: document.getElementById("company-name").value,
                industry: document.getElementById("company-industry").value,
                country: document.getElementById("company-country").value,
                notes: document.getElementById("company-notes").value,
              };
              app.saveData();
            },
            render() {
              if (!app.data.companyInfo) return;
              document.getElementById("company-name").value =
                app.data.companyInfo.name || "";
              document.getElementById("company-industry").value =
                app.data.companyInfo.industry || "";
              document.getElementById("company-country").value =
                app.data.companyInfo.country || "Palestine";
              document.getElementById("company-notes").value =
                app.data.companyInfo.notes || "";
            },
          },

          ife: {
            add() {
              const text = document.getElementById("ife-text").value;
              const type = document.getElementById("ife-type").value;
              const weight = parseFloat(
                document.getElementById("ife-weight").value
              );
              const rating = parseInt(
                document.getElementById("ife-rating").value
              );

              if (!text || !weight || !rating)
                return alert("Please fill all fields");

              app.data.ife.items.push({
                id: Date.now(),
                text,
                type,
                weight,
                rating,
              });
              app.ife.render();
              app.saveData();

              document.getElementById("ife-text").value = "";
              document.getElementById("ife-weight").value = "";
              document.getElementById("ife-rating").value = "";
            },

            delete(id) {
              app.data.ife.items = app.data.ife.items.filter(
                (i) => i.id !== id
              );
              app.ife.render();
              app.saveData();
            },

            render() {
              const tableBody = document.querySelector("#ife-table tbody");
              tableBody.innerHTML = "";
              let totalWeight = 0;
              let totalScore = 0;

              app.data.ife.items.forEach((item) => {
                const weightedScore = (item.weight * item.rating).toFixed(2);
                totalWeight += item.weight;
                totalScore += parseFloat(weightedScore);

                const row = tableBody.insertRow();
                row.innerHTML = `
                        <td>${item.text}</td>
                        <td>${
                          item.type === "strength" ? "Strength" : "Weakness"
                        }</td>
                        <td>${item.weight.toFixed(2)}</td>
                        <td>${item.rating}</td>
                        <td><strong>${weightedScore}</strong></td>
                        <td><button class="danger" onclick="app.ife.delete(${
                          item.id
                        })">Delete</button></td>
                    `;
              });

              const totalsDiv = document.getElementById("ife-totals");
              const analysis =
                totalScore > 2.5
                  ? "Strong Internal Position"
                  : totalScore < 2.5
                  ? "Weak Internal Position"
                  : "Average Internal Position";
              totalsDiv.innerHTML = `
                    <p>Total Weight: <span style="color: ${
                      totalWeight.toFixed(2) == 1.0 ? "green" : "red"
                    }">${totalWeight.toFixed(2)}</span> (Should be 1.0)</p>
                    <p>Total Weighted Score: <strong>${totalScore.toFixed(
                      2
                    )}</strong></p>
                    <p class="analysis-result"><strong>Analysis:</strong> ${analysis} (Score: ${totalScore.toFixed(
                2
              )})</p>
                `;
            },

            export() {
              const rows = [
                [
                  "Type",
                  "Factor Description",
                  "Weight",
                  "Rating",
                  "Weighted Score",
                ],
              ];
              let totalWeight = 0;
              let totalScore = 0;

              app.data.ife.items.forEach((item) => {
                const score = (item.weight * item.rating).toFixed(2);
                rows.push([
                  item.type,
                  item.text,
                  item.weight.toFixed(2),
                  item.rating,
                  score,
                ]);
                totalWeight += item.weight;
                totalScore += parseFloat(score);
              });

              rows.push([]);
              rows.push([
                "Total",
                "",
                totalWeight.toFixed(2),
                "Total Score:",
                totalScore.toFixed(2),
              ]);
              app.exportToCSV("ife_matrix.csv", rows);
            },
          },

          efe: {
            add() {
              const text = document.getElementById("efe-text").value;
              const type = document.getElementById("efe-type").value;
              const weight = parseFloat(
                document.getElementById("efe-weight").value
              );
              const rating = parseInt(
                document.getElementById("efe-rating").value
              );

              if (!text || !weight || !rating)
                return alert("Please fill all fields");

              app.data.efe.items.push({
                id: Date.now(),
                text,
                type,
                weight,
                rating,
              });
              app.efe.render();
              app.saveData();

              document.getElementById("efe-text").value = "";
              document.getElementById("efe-weight").value = "";
              document.getElementById("efe-rating").value = "";
            },

            delete(id) {
              app.data.efe.items = app.data.efe.items.filter(
                (i) => i.id !== id
              );
              app.efe.render();
              app.saveData();
            },

            render() {
              const tableBody = document.querySelector("#efe-table tbody");
              tableBody.innerHTML = "";
              let totalWeight = 0;
              let totalScore = 0;

              app.data.efe.items.forEach((item) => {
                const weightedScore = (item.weight * item.rating).toFixed(2);
                totalWeight += item.weight;
                totalScore += parseFloat(weightedScore);

                const row = tableBody.insertRow();
                row.innerHTML = `
                        <td>${item.text}</td>
                        <td>${
                          item.type === "opportunity" ? "Opportunity" : "Threat"
                        }</td>
                        <td>${item.weight.toFixed(2)}</td>
                        <td>${item.rating}</td>
                        <td><strong>${weightedScore}</strong></td>
                        <td><button class="danger" onclick="app.efe.delete(${
                          item.id
                        })">Delete</button></td>
                    `;
              });

              const totalsDiv = document.getElementById("efe-totals");
              const analysis =
                totalScore > 2.5
                  ? "Strong Response to Environment"
                  : totalScore < 2.5
                  ? "Weak Response to Environment"
                  : "Average Response";
              totalsDiv.innerHTML = `
                    <p>Total Weight: <span style="color: ${
                      totalWeight.toFixed(2) == 1.0 ? "green" : "red"
                    }">${totalWeight.toFixed(2)}</span> (Should be 1.0)</p>
                    <p>Total Weighted Score: <strong>${totalScore.toFixed(
                      2
                    )}</strong></p>
                    <p class="analysis-result"><strong>Analysis:</strong> ${analysis} (Score: ${totalScore.toFixed(
                2
              )})</p>
                `;
            },

            export() {
              const rows = [
                [
                  "Type",
                  "Factor Description",
                  "Weight",
                  "Rating",
                  "Weighted Score",
                ],
              ];
              let totalWeight = 0;
              let totalScore = 0;

              app.data.efe.items.forEach((item) => {
                const score = (item.weight * item.rating).toFixed(2);
                rows.push([
                  item.type,
                  item.text,
                  item.weight.toFixed(2),
                  item.rating,
                  score,
                ]);
                totalWeight += item.weight;
                totalScore += parseFloat(score);
              });

              rows.push([]);
              rows.push([
                "Total",
                "",
                totalWeight.toFixed(2),
                "Total Score:",
                totalScore.toFixed(2),
              ]);
              app.exportToCSV("efe_matrix.csv", rows);
            },
          },

          cpm: {
            addCompetitor() {
              const name = document.getElementById("cpm-competitor-name").value;
              if (!name) return alert("Please enter a name");
              app.data.cpm.competitors.push(name);

              app.data.cpm.factors.forEach((f) => f.ratings.push(0));

              app.cpm.render();
              app.saveData();
              document.getElementById("cpm-competitor-name").value = "";
            },

            deleteCompetitor(index) {
              if (index === 0) return alert("Cannot delete 'My Firm'");
              app.data.cpm.competitors.splice(index, 1);
              app.data.cpm.factors.forEach((f) => f.ratings.splice(index, 1));
              app.cpm.render();
              app.saveData();
            },

            addFactor() {
              const text = document.getElementById("cpm-factor-text").value;
              const weight = parseFloat(
                document.getElementById("cpm-factor-weight").value
              );
              if (!text || !weight) return alert("Please fill all fields");

              const ratings = new Array(app.data.cpm.competitors.length).fill(
                1
              );
              app.data.cpm.factors.push({
                id: Date.now(),
                text,
                weight,
                ratings,
              });

              app.cpm.render();
              app.saveData();
              document.getElementById("cpm-factor-text").value = "";
              document.getElementById("cpm-factor-weight").value = "";
            },

            deleteFactor(id) {
              app.data.cpm.factors = app.data.cpm.factors.filter(
                (f) => f.id !== id
              );
              app.cpm.render();
              app.saveData();
            },

            updateRating(factorId, compIndex, value) {
              const factor = app.data.cpm.factors.find(
                (f) => f.id === factorId
              );
              factor.ratings[compIndex] = parseInt(value);
              app.cpm.render();
              app.saveData();
            },

            render() {
              const competitors = app.data.cpm.competitors;
              const factors = app.data.cpm.factors;

              document.getElementById("cpm-competitor-list").textContent =
                competitors.join(", ");

              const tableHead = document.querySelector("#cpm-table thead");
              const tableBody = document.querySelector("#cpm-table tbody");
              const tableFoot = document.querySelector("#cpm-table tfoot");

              let headHTML =
                "<tr><th>Critical Success Factor</th><th>Weight</th>";
              competitors.forEach((name, index) => {
                headHTML += `<th>${name} Rating</th><th>${name} Score</th>`;
              });
              headHTML += "<th>Actions</th></tr>";
              tableHead.innerHTML = headHTML;

              tableBody.innerHTML = "";
              let totalWeight = 0;
              let columnTotals = new Array(competitors.length).fill(0);

              factors.forEach((factor) => {
                let rowHTML = `
                        <td>${factor.text}</td>
                        <td>${factor.weight.toFixed(2)}</td>
                    `;
                totalWeight += factor.weight;

                factor.ratings.forEach((rating, index) => {
                  const score = (rating * factor.weight).toFixed(2);
                  columnTotals[index] += parseFloat(score);
                  rowHTML += `
                            <td><input type="number" min="1" max="4" value="${rating}" oninput="app.cpm.updateRating(${factor.id}, ${index}, this.value)"></td>
                            <td><strong>${score}</strong></td>
                        `;
                });

                rowHTML += `<td><button class="danger" onclick="app.cpm.deleteFactor(${factor.id})">Delete</button></td>`;
                tableBody.innerHTML += `<tr>${rowHTML}</tr>`;
              });

              let footHTML = `<tr>
                    <td><strong>TOTALS</strong></td>
                    <td><strong style="color: ${
                      totalWeight.toFixed(2) == 1.0 ? "green" : "red"
                    }">${totalWeight.toFixed(2)}</strong></td>
                `;
              competitors.forEach((name, index) => {
                footHTML += `
                        <td>---</td>
                        <td><strong>${columnTotals[index].toFixed(
                          2
                        )}</strong></td>
                    `;
              });
              footHTML += "<td>---</td></tr>";
              tableFoot.innerHTML = footHTML;
            },

            export() {
              const competitors = app.data.cpm.competitors;
              const factors = app.data.cpm.factors;

              const header = ["Critical Success Factor", "Weight"];
              let columnTotals = new Array(competitors.length).fill(0);

              competitors.forEach((name) => {
                header.push(`${name} Rating`);
                header.push(`${name} Score`);
              });

              const rows = [header];
              let totalWeight = 0;

              factors.forEach((factor) => {
                const row = [factor.text, factor.weight.toFixed(2)];
                totalWeight += factor.weight;

                factor.ratings.forEach((rating, index) => {
                  const score = (rating * factor.weight).toFixed(2);
                  columnTotals[index] += parseFloat(score);
                  row.push(rating);
                  row.push(score);
                });
                rows.push(row);
              });

              const footer = ["TOTAL", totalWeight.toFixed(2)];
              competitors.forEach((name, index) => {
                footer.push("---");
                footer.push(columnTotals[index].toFixed(2));
              });
              rows.push(footer);

              app.exportToCSV("cpm_matrix.csv", rows);
            },
          },

          bcg: {
            add() {
              const name = document.getElementById("bcg-division").value;
              const firmRevenue = parseFloat(
                document.getElementById("bcg-firm-revenue").value
              );
              const rivalRevenue = parseFloat(
                document.getElementById("bcg-rival-revenue").value
              );
              const growth = parseFloat(
                document.getElementById("bcg-growth").value
              );

              if (
                !name ||
                isNaN(firmRevenue) ||
                isNaN(rivalRevenue) ||
                isNaN(growth)
              )
                return alert("Please fill all fields");
              if (rivalRevenue === 0)
                return alert("Top Rival's Revenue cannot be zero.");

              const rmsp = (firmRevenue / rivalRevenue).toFixed(2);
              const safeRevenue = Math.max(1, firmRevenue);
              const radius = 5 + Math.log10(safeRevenue) * 3;

              app.data.bcg.items.push({
                x: rmsp,
                y: growth,
                r: radius,
                label: name,
                revenue: firmRevenue,
                rivalRevenue: rivalRevenue,
              });
              app.bcg.render();
              app.saveData();

              document.getElementById("bcg-division").value = "";
              document.getElementById("bcg-firm-revenue").value = "";
              document.getElementById("bcg-rival-revenue").value = "";
              document.getElementById("bcg-growth").value = "";
            },

            clear() {
              if (
                confirm("Are you sure you want to clear all BCG divisions?")
              ) {
                app.data.bcg.items = [];
                app.bcg.render();
                app.saveData();
              }
            },

            render() {
              const ctx = document.getElementById("bcgChart").getContext("2d");
              if (app.charts.bcg) app.charts.bcg.destroy();

              const datasets = app.data.bcg.items.map((item) => {
                const quadrant =
                  item.x >= 0.5 && item.y >= 0
                    ? "Star"
                    : item.x < 0.5 && item.y >= 0
                    ? "Question Mark"
                    : item.x >= 0.5 && item.y < 0
                    ? "Cash Cow"
                    : "Dog";
                const color =
                  quadrant === "Star"
                    ? "rgba(54, 162, 235, 0.7)"
                    : quadrant === "Question Mark"
                    ? "rgba(255, 159, 64, 0.7)"
                    : quadrant === "Cash Cow"
                    ? "rgba(75, 192, 192, 0.7)"
                    : "rgba(255, 99, 132, 0.7)";

                return {
                  label: `${item.label} (${quadrant})`,
                  data: [{ x: item.x, y: item.y, r: item.r }],
                  backgroundColor: color,
                };
              });

              app.charts.bcg = new Chart(ctx, {
                type: "bubble",
                data: { datasets },
                options: {
                  responsive: true,
                  plugins: {
                    title: { display: true, text: "BCG Matrix" },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          const item = app.data.bcg.items[context.datasetIndex];
                          return `${item.label}: (RMSP: ${item.x}, Growth: ${
                            item.y
                          }%, Revenue: $${item.revenue.toLocaleString()})`;
                        },
                      },
                    },
                    annotation: {
                      annotations: {
                        line1: {
                          type: "line",
                          yMin: 0,
                          yMax: 0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                        line2: {
                          type: "line",
                          xMin: 0.5,
                          xMax: 0.5,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                      },
                    },
                  },
                  scales: {
                    x: {
                      title: {
                        display: true,
                        text: "Relative Market Share Position (RMSP)",
                      },
                      reverse: true,
                      min: 0,
                      max: 1.0,
                      ticks: { stepSize: 0.1 },
                    },
                    y: {
                      title: {
                        display: true,
                        text: "Industry Growth Rate (%)",
                      },
                      min: -20,
                      max: 20,
                      ticks: { stepSize: 5 },
                    },
                  },
                },
              });
            },
          },

          aiReport: {
            apiKey: "AIzaSyAgqtZVBiwfZqsyweNdSVb-HvHTwDNxefU",

            _gatherData() {
              let context = "START OF DATA:\n\n";

              context += "== COMPANY INFO ==\n";
              context += `Name: ${app.data.companyInfo.name}\n`;
              context += `Industry: ${app.data.companyInfo.industry}\n`;
              context += `Country/Region: ${app.data.companyInfo.country}\n`;
              context += `Notes: ${app.data.companyInfo.notes}\n\n`;

              const ifeScore = app.data.ife.items
                .reduce((acc, i) => acc + i.weight * i.rating, 0)
                .toFixed(2);
              context += `== IFE MATRIX (Total Score: ${ifeScore}) ==\n`;
              context += "Strengths:\n";
              app.data.ife.items
                .filter((i) => i.type === "strength")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "Weaknesses:\n";
              app.data.ife.items
                .filter((i) => i.type === "weakness")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "\n";

              const efeScore = app.data.efe.items
                .reduce((acc, i) => acc + i.weight * i.rating, 0)
                .toFixed(2);
              context += `== EFE MATRIX (Total Score: ${efeScore}) ==\n`;
              context += "Opportunities:\n";
              app.data.efe.items
                .filter((i) => i.type === "opportunity")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "Threats:\n";
              app.data.efe.items
                .filter((i) => i.type === "threat")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "\n";

              context += "== CPM MATRIX ==\n";
              context += `Competitors: ${app.data.cpm.competitors.join(
                ", "
              )}\n`;
              app.data.cpm.factors.forEach((f) => {
                context += `- Factor: ${f.text} (W:${
                  f.weight
                }), Ratings: [${f.ratings.join(", ")}]\n`;
              });
              context += "\n";

              context += "== BCG MATRIX ==\n";
              app.data.bcg.items.forEach((i) => {
                context += `- Division: ${i.label} (Growth: ${i.y}%, RMSP: ${i.x}, Revenue: ${i.revenue})\n`;
              });
              context += "\n";

              context += "END OF DATA\n";
              return context;
            },

            async generate() {
              const language = document.getElementById("ai-language").value;
              const btn = document.getElementById("ai-generate-btn");
              const loader = document.getElementById("ai-loader");
              const output = document.getElementById("ai-report-output");

              btn.disabled = true;
              loader.style.display = "block";
              output.textContent =
                "Gathering data and contacting AI... This may take up to 30 seconds.";

              if (language === "Arabic") {
                output.style.direction = "rtl";
              } else {
                output.style.direction = "ltr";
              }

              try {
                const dataContext = this._gatherData();
                const prompt = `
                        You are a professional strategic management consultant. Your task is to write a full strategic analysis report for a client based on the data they provided.

                        Here is the data:
                        ${dataContext}

                        Your report must be written in ${language}.
                        
                        Please structure your report as follows:
                        1.  **Executive Summary:** A brief overview of the company's current strategic position and key recommendations.
                        2.  **Internal Analysis (IFE):** Analyze the total score, key strengths, and key weaknesses.
                        3.  **External Analysis (EFE):** Analyze the total score, key opportunities, and key threats.
                        4.  **Competitive Landscape (CPM):** Analyze the company's position against its competitors based on the CPM scores.
                        5.  **Portfolio Analysis (BCG):** Analyze the divisions based on the BCG data.
                        6.  **Strategic Recommendations:** Based on all the data provided (IFE, EFE, CPM, BCG), provide 3-5 concrete, actionable strategic recommendations.

                        Be professional, insightful, and use the data to justify your conclusions.
                    `;

                const response = await fetch(
                  `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      contents: [
                        {
                          parts: [{ text: prompt }],
                        },
                      ],
                    }),
                  }
                );

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(`API Error: ${errorData.error.message}`);
                }

                const data = await response.json();

                if (data.candidates && data.candidates.length > 0) {
                  const reportText = data.candidates[0].content.parts[0].text;
                  output.textContent = reportText;
                } else {
                  output.textContent =
                    "Error: No response from AI. The prompt may have been blocked or the API key is invalid/rate-limited.";
                }
              } catch (error) {
                output.textContent = `An error occurred: ${error.message}\n\nPlease check the console (F12) for more details. This often happens if the API key is incorrect or has restrictions.`;
                console.error("AI Report Error:", error);
              } finally {
                btn.disabled = false;
                loader.style.display = "none";
              }
            },
          },
        };

        window.app = app;
        window.addEventListener("DOMContentLoaded", app.init);
      })();
    </script>
  </body>
</html>
